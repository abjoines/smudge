---
layout: post
title:  "Texturing a Brick Wall Without Hitting a Brick Wall"
date:   2017-06-13 21:12:54 -0500
categories: shaders
author: Talia Cotton
---

Using the API to build a brick texture -- as the first implementation of the API -- was a good exploration of its potential as well as a good indication of other functions from which the API would benefit.

At this stage in the API there were only two basic functions: (1) the ability to make a material with color+transparency, metallic, smoothness and height, as well as (2) the ability to draw a rectangle. These alone were the primary functions -- used along with pure javascript -- that were used to build the brick texture.

The general process to set up the grid was as follows:
1. Establish the dimensions of each brick, as well as the space between them (the mortar). Define these as variables, so they can be changed later.
2. Loop through the canvas, and draw a rectangle (a brick, using pbr.rect) of the predefined brick size at every x,y point of the start of a brick. Keeping in mind: every other row the x-start is half a brick-width sooner. This gives it more of an organic brick "feel". (in code, this means every other row starts at x - brickWidth/2).

Then to add a simple material:
At this stage, there are only two parts being drawn: the canvas below the bricks (the mortar), as well as each brick. This translates to the first two Materials. The canvas/mortar material (1) was initially given a grey-ish color, and a height of 0.1. The bricks material (2) was also a simple color and height, but the loop gave the opportunity to diversify the color of each brick. With a random function written outside the pbr function, a random variation of color was applied to each brick.

At this point the Simple Bricks texture (albedo channel shown here) was set up. In a sentence: make a brick material, draw a series of procedurally positioned rectangles with that material, whose r g and b values get slightly modified at every instance. Already it looks like ~something~.

<div class="figures">
    <figure>
        <img src="{{site.baseurl}}/media/bricks/bricks_basic_albedo.png">
        <figcaption>
        Albedo Channel: Simple Brick Texture, showing grid and varying colors.
        </figcaption>
    </figure>
</div>

Observing existing brick textures, a few qualities were noted as a base guide to building them using the pbr5 library. Qualities include: color alteration within each brick, speckles on some, edge "noise" (bricks aren't usually perfect rectangles), surface flaws (randomized indents, roughness, etc).

The first iteration of a more complex brick texture drew several randomly placed small rectangles within (above) each brick base (each one a relative of the brick base color) with a low transparency. The result was a watercolory blend of colors above each brick. Speckles were added by a similar process, whereby the material was a simple all-white semi-transparent material, applied randomly within/above each brick as 1x1 rects.

An issue immediately became visible: that somehow the mortar's height was being drawn higher than that of the bricks... even though the brick base was defined as higher than the mortar height. (shown here "Misstep 1").

<div class="figures">
    <figure>
        <img src="{{site.baseurl}}/media/bricks/bricks_basic_albedo.png">
        <figcaption>
        Misstep 1: Complex brick texture, erroneous heights.
        </figcaption>
    </figure>
</div>

What was happening was that although a height was assigned to each brick base, once the brick overlay texture was applied -- with a height of 0 -- the brick was leveled out again. The embossing around the edges was the brick base (with a high height) peaking out wherever a brick overlay was not drawn. Clearly when leveling materials one must keep in mind the qualities of the material below it if he or she wants it to be additive.

Going forward the brick overlay texture was given the same height as the brick base, but this caused the second misstep: the render lost its organic edge noise that was seen as a result of misstep 1. Each brick -- although now appropriately protruding from the mortar -- was perfectly rectangle, which is unwanted for a realistic brick texture.

The epiphany to get this right was accidental -- drawing the brick base was temporarily commented out, and bingo! Organic brick-ish shapes beautified the canvas. In retrospect the solution was to not-draw the brick base texture at all, but rather to only draw the brick overlays at the same height that each brick would be (perhaps with some variation). This ensured a nice rough border variation for each brick.


<div class="figures">
    <figure>
        <img src="{{site.baseurl}}/media/bricks/bricks_height0.png">
        <figcaption>
        Height Channel, Misstep 1: Height of "Bricks Overlay" as 0;
        </figcaption>
    </figure>
    <figure>
        <img src="{{site.baseurl}}/media/bricks/bricks_height1.png">
        <figcaption>
        Height Channel, Misstep 2: Improved mortar-to-brick height relation, but lost edge roughness;
        </figcaption>
    </figure>
    <figure>
        <img src="{{site.baseurl}}/media/bricks/bricks_height2.png">
        <figcaption>
        Height Channel, Solution: "Bricks Base" not drawn; "bricks overlay" assigned height and drawn above mortar height; achieves edge roughness as well as correct height.
        </figcaption>
    </figure>
</div>


A few functions that would be useful for the future, as a reflection of some of the struggles as well as epiphanies of building the brick wall:
1. If there were some sort of "mask," it would have saved a lot of time calculating the areas on the canvas on which a brick was being drawn, so that some other textures could be overlaid in the right place. Not only this, but a mask would allow for more complex shapes in the future.
2. In addition to the option to make materials, perhaps a library of pre-sketched textures would be useful to a user, assuming he/she gets control over some parameters. As an example, the "speckles" function was called several times over with slight modifications each time. Perhaps something like the speckles function, as well as the overlay texture function for each brick, could become more universal.
3. In response to the misstep resulting in "negative bricks": perhaps there is a solution to deactivate some of the channels within each material (as an example: "material.height = undefined"). Either this, or to automatically build on top of a previous material without having to replicate its parameters. While this would surely make the library more intuitive, it's not as clear whether this would add functionality.
